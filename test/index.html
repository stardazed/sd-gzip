<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>sd-zip tests</title>
	<script src="../node_modules/@stardazed/adler32/dist/sd-adler32.umd.js"></script>
	<script src="../dist/sd-zip.umd.js"></script>
</head>
<body>
<script type="module">
// @ts-check
/**
 * Just a quick manual testing page to check deflate results.
 *
 * The text .deflate files were made by using gzip on some text files and manually
 * changing the file format to:
 * 0x7801, data(BLOCKS), checksum(CRC32)
 *
 * The binary test file is the data part of a block from an FBX binary file
 * containing vertex data and a checksum, in its unaltered form:
 * 0x7801, data(BLOCKS), checksum(Adler32)
 */

// @ts-ignore
const { adler32 } = sdAdler32;
// @ts-ignore
const { Inflater, inflate } = sdInflate;

function testInflateParts(fileName) {
	return Promise.all([fetch(`./${fileName}.part1.deflate`), fetch(`./${fileName}.part2.deflate`), fetch(`./${fileName}.txt`)])
		.then(([rD, rD2, rT]) => Promise.all([rD.arrayBuffer(), rD2.arrayBuffer(), rT.text()]))
		.then(([ab, ab2, text]) => {
			const inflater = new Inflater();
			// pass in two buffers
			const dataDeflated1 = new Uint8Array(ab, 0, ab.byteLength);
			inflater.append(dataDeflated1);
			const dataDeflated2 = new Uint8Array(ab2, 0, ab2.byteLength); // no checksum was added to the parts file
			inflater.append(dataDeflated2);

			const result = inflater.finish();

			// check decompressed data against original
			const contents = (new TextDecoder()).decode(result);

			// report success
			const success = contents === text;
			console.info("TEST (multi-part) done", fileName, success);
			return success;
		})
		.catch(err => {
			console.warn("Error during test (multi-part)", fileName, err);
			return false;
		});
}

function testInflateText(fileName) {
	return Promise.all([fetch(`./${fileName}.deflate`), fetch(`./${fileName}.txt`)])
		.then(([rD, rT]) => Promise.all([rD.arrayBuffer(), rT.text()]))
		.then(async ([ab, text]) => {
			// decompress data
			const result = await inflate(new Uint8Array(ab, 0, ab.byteLength - 4));

			// check decompressed data against original
			const contents = (new TextDecoder()).decode(result);

			// report success
			const success = contents === text;
			console.info("TEST (text) done", fileName, success);
			return success;
		})
		.catch(err => {
			console.warn("Error during test (text)", fileName, err);
			return false;
		});
}


function testInflateBinary(fileName) {
	return fetch(`./${fileName}.deflate`)
		.then(rD => rD.arrayBuffer())
		.then(ab => {
			// decompress data
			const inflater = new Inflater({ allowPartialData: true });
			const dataDeflated = new Uint8Array(ab, 0, ab.byteLength - 4);
			inflater.append(dataDeflated);
			const result = inflater.finish();

			const checkSumStored = new DataView(ab, ab.byteLength - 4, 4).getUint32(0, false);
			const checkSumVerify = adler32(result);

			console.info(checkSumStored.toString(16), checkSumVerify.toString(16));

			// report success
			const success = checkSumStored === checkSumVerify;
			console.info("TEST (binary) done", fileName, success);
			return success;
		})
		.catch(err => {
			console.warn("Error during test (binary)", fileName, err);
			return false;
		});
}

function runTests() {
	Promise.all([
		testInflateText("simple"),
		testInflateText("paradiselost"),
		testInflateParts("paradiselost"),
		testInflateBinary("vertices")
	])
	.then(results => {
		console.info("DONE");
	});
}

runTests();
</script>
</body>
</html>
